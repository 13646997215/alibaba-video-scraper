<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¯Šæ–­ä¸­å¿ƒ - Alibaba Video Scraper</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app-shell">
      <main class="container">
        <header class="hero-card">
          <div class="hero-badge">è¯Šæ–­å·¥å…·</div>
          <h1>ğŸ§ª API è¯Šæ–­ä¸­å¿ƒ</h1>
          <p>ä¸€é”®æ£€æŸ¥ health / diag / scrape / extractï¼Œå®šä½çº¿ä¸Šå¤±è´¥åŸå› ã€‚</p>
          <div class="hero-tools">
            <a class="btn btn-soft nav-link" href="index.html">è¿”å›ä¸»é¡µé¢</a>
            <a class="btn btn-soft nav-link" href="help.html">æŸ¥çœ‹å¸®åŠ©</a>
          </div>
        </header>

        <section class="card">
          <label class="field-label" for="diagApiBase">API Base</label>
          <input id="diagApiBase" class="filter-input" type="text" value="/api" />
          <label class="field-label" for="diagUrl">æµ‹è¯•é“¾æ¥</label>
          <input
            id="diagUrl"
            class="url-input"
            type="text"
            value="https://www.alibaba.com/product-detail/Custom-Wholesale-Metal-Rimless-Sunglasses-with_1601426961544.html?spm=a2700.product_home_fy25.just_for_you.15.2ce26e58c8Uu5k"
          />
          <div class="quick-actions">
            <button id="runDiagBtn" class="btn btn-primary" type="button">è¿è¡Œå…¨é‡è¯Šæ–­</button>
            <button id="copyDiagBtn" class="btn btn-soft" type="button">å¤åˆ¶è¯Šæ–­ç»“æœ</button>
          </div>
        </section>

        <section class="card">
          <div class="status-text">è¯Šæ–­ç»“æœ</div>
          <pre id="diagOutput" class="diag-output">ç­‰å¾…æ‰§è¡Œ...</pre>
        </section>
      </main>
    </div>

    <script>
      const runDiagBtn = document.getElementById('runDiagBtn');
      const copyDiagBtn = document.getElementById('copyDiagBtn');
      const diagOutput = document.getElementById('diagOutput');
      const diagApiBase = document.getElementById('diagApiBase');
      const diagUrl = document.getElementById('diagUrl');

      function normalizeBase(base) {
        const value = (base || '/api').trim();
        if (!value) return '/api';
        return value.endsWith('/') ? value.slice(0, -1) : value;
      }

      async function requestJson(url, options = {}) {
        const response = await fetch(url, options);
        const data = await response.json().catch(() => ({}));
        return { ok: response.ok, status: response.status, data };
      }

      function append(line) {
        diagOutput.textContent += `\n${line}`;
      }

      runDiagBtn.addEventListener('click', async () => {
        const base = normalizeBase(diagApiBase.value);
        const target = diagUrl.value.trim();
        if (!target) {
          alert('è¯·è¾“å…¥æµ‹è¯•é“¾æ¥');
          return;
        }

        diagOutput.textContent = 'å¼€å§‹è¯Šæ–­...';
        const checks = [
          ['health', 'GET', `${base}/health`, null],
          ['diag', 'POST', `${base}/diag`, { url: target }],
          ['scrape', 'POST', `${base}/scrape`, { url: target }],
          ['extract', 'POST', `${base}/extract`, { url: target }],
        ];

        const result = { started_at: new Date().toISOString(), checks: {} };

        for (const [name, method, url, body] of checks) {
          append(`\n--- ${name.toUpperCase()} ---`);
          try {
            const payload = await requestJson(url, {
              method,
              headers: body ? { 'Content-Type': 'application/json' } : undefined,
              body: body ? JSON.stringify(body) : undefined,
            });
            result.checks[name] = payload;
            append(`status=${payload.status} ok=${payload.ok}`);
            append(JSON.stringify(payload.data, null, 2));
          } catch (error) {
            result.checks[name] = { ok: false, status: 0, error: String(error) };
            append(`error: ${String(error)}`);
          }
        }

        result.finished_at = new Date().toISOString();
        window.__diagResult = result;
      });

      copyDiagBtn.addEventListener('click', async () => {
        const text = window.__diagResult
          ? JSON.stringify(window.__diagResult, null, 2)
          : diagOutput.textContent;
        try {
          await navigator.clipboard.writeText(text);
          alert('å·²å¤åˆ¶è¯Šæ–­ç»“æœ');
        } catch {
          alert('å¤åˆ¶å¤±è´¥');
        }
      });
    </script>
  </body>
</html>
